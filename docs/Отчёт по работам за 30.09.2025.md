Отчёт по актуальному состоянию инфраструктуры и архитектуры — 30 сентября 2025

## Резюме

- Базовый стек подтверждён: **Next.js 15.5.3 (App Router, React 19)**, **Strapi v5.23.6**, **PostgreSQL 14-alpine**, **Meilisearch v1.7**, **Nginx + Certbot**.
- Все сервисы упакованы в Docker и управляются двумя compose-файлами (`development.compose.yml` и `production.compose.yml`). В качестве базового образа в Node-сервисах используется **node:22-alpine** с глобально установленным `pnpm`.
- Дев-сборка фронтенда и Strapi работает в режиме `pnpm dev`/`pnpm develop` с подключенными volume для `src` и `public`, что даёт горячую перезагрузку без пересборки контейнеров.
- Продовая цепочка фронтенда включает healthcheck-скрипт ожидания `/_health` Strapi и выполняет `pnpm build` перед запуском `pnpm start`, обеспечивая консистентность схемы данных и контента.

## Компоненты

### Frontend (Next.js)
- Next.js 15.5.3 с App Router (`src/app`) и стандартным layout. Пока используется шаблонная страница `page.tsx`.
- Зависимости: React/React DOM 19.1.0, TypeScript 5, ESLint 9, `eslint-config-next`.
- `next.config.ts` прокидывает окружение (`API_CONTAINER_URL`, `API_CLIENT_URL`, `API_TOKEN`, `NEXT_PUBLIC_MEILISEARCH_HOST`, `NEXT_PUBLIC_MEILISEARCH_API_KEY`) в рантайм.
- Дев Dockerfile (`docker/development/Dockerfile.frontend`): `pnpm install`, команду `pnpm run dev`, проброс портов `3000`, volumes для `public` и `src` → HMR без rebuild.
- Прод Dockerfile (`docker/production/Dockerfile.frontend`): устанавливает `curl`, глобально `pnpm`, копирует исходники, прописывает ENV из build-аргументов. Точка входа — `healthcheck.strapi.sh`, который ждёт доступности `http://strapi:1337/_health`, выполняет `pnpm build`, затем `pnpm start` (порт 3000).

### CMS (Strapi)
- Strapi 5.23.6 с базовыми плагинами (`@strapi/plugin-users-permissions`, `@strapi/plugin-cloud`) и интеграцией `strapi-plugin-meilisearch`.
- Конфигурация БД (`config/database.ts`): поддержка postgres/mysql/sqlite, дефолт — postgres с параметрами из ENV (`DATABASE_*`, `DATABASE_URL`).
- Конфигурация сервера (`config/server.ts`): прокидывает `API_CLIENT_URL` в `url`, ключи приложения читаются из `APP_KEYS`.
- Плагины (`config/plugins.ts`): Meilisearch активируется при наличии `MEILISEARCH_HOST` и `MEILISEARCH_MASTER_KEY`.
- Дев Dockerfile (`docker/development/Dockerfile.strapi`): `pnpm run develop`, volumes на `config`, `database`, `public`, `src`.
- Прод Dockerfile (`docker/production/Dockerfile.strapi`): билд `pnpm run build`, запуск `pnpm run start`. В рантайме ожидает postgres и meilisearch (через `depends_on`).
- Контентные типы пока не заведены (`src/api` пустой), админка — дефолтная (примерный `app.example.tsx`).

### База данных
- Postgres 14-alpine, volume `postgresql_database` (dev) / `postgres-data` (prod). Авторизация через `DATABASE_USERNAME`/`DATABASE_PASSWORD`.
- Для Strapi схема по умолчанию `public`, в env доступна опциональная `DATABASE_SCHEMA`.

### Поиск
- Meilisearch `getmeili/meilisearch:v1.7`, volume `meilisearch_data`/`meilisearch-data`.
- Ключи: `MEILISEARCH_MASTER_KEY` используется и Strapi, и фронтендом (`NEXT_PUBLIC_MEILISEARCH_API_KEY` на данный момент совпадает и требует ограничений на проде).

### Веб-сервер и SSL
- Production compose добавляет `nginx` и `certbot`.
- `nginx/default.conf`:
  - Отдельные upstream для `frontend:3000` и `strapi:1337`.
  - HTTP-запросы на основной домен перенаправляются на HTTPS, `/strapi` → `api`-поддомен.
  - HTTPS-конфиг проксирует Next.js и Strapi, включает кеширование `/static` и `/_next/static`.
  - Для Strapi проброшен `_health` для внешних проверок.
- `nginx/healthcheck.frontend.sh` ждёт отклика Next.js перед стартом nginx (использовать как entrypoint при необходимости).
- `certbot` обслуживает HTTP-01 challenge через `/var/www/certbot`, сертификаты ожидаются в `certbot/conf/live/vpsmarcus.itts.su/`.

## Compose-профили

### Development (`docker/development.compose.yml`)
- Сервисы: `frontend`, `strapi`, `database`, `meilisearch` в сети `internal`.
- `frontend` зависит от `strapi`, подключается к API через `API_CONTAINER_URL` (обычно `http://strapi:1337`).
- Обновление кода происходит через смонтированные каталоги, hot reload доступен без пересоздания образа.

### Production (`docker/production.compose.yml`)
- Сервисы: `nginx`, `certbot`, `frontend`, `strapi`, `database`, `meilisearch`.
- `frontend` и `strapi` подтягивают ENV через build args; для frontend дополнительно пробрасываются директории `public/src` (упростит замену статики без rebuild).
- `strapi` ожидает `database` и `meilisearch`; `frontend` запускается после успешного healthcheck Strapi.
- Рестарт-политика `unless-stopped` на всех сервисах, кроме `certbot`.

## Операционные наблюдения

- Стартовый `_health` Strapi (встроенный в v5) обеспечивает корректную последовательность запуска фронтенда в проде.
- Дев-режим Next.js не требует увеличения лимитов inotify: HMR работает штатно благодаря volume и `WATCHPACK_POLLING=true`.
- Для prod следует сгенерировать отдельный search-only ключ Meilisearch и отдать его фронтенду вместо master key.
- Добавление favicon и базовых страниц снизит шум 404 в логах nginx и Strapi.
- Из компонентов, обозначенных в «Проектирование интернет-магазина Marcus (Next.js + Strapi).md», пока не внедрены Redis, S3/CDN и автоматизация CI/CD — требуется учесть их в дорожной карте.

## Следующие шаги

1. Завести базовые коллекции в Strapi согласно ТЗ и обновить meilisearch-индексацию.
2. Вынести search-only ключ в переменные окружения фронтенда.
3. Настроить CI на запуск `pnpm -w lint` / `pnpm -w typecheck` по инструкциям из корневого `AGENTS.md`.
4. Подготовить `docs/DECISIONS.md` при первом отступлении от ТЗ.
