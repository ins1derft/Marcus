Отчёт по актуальному состоянию инфраструктуры и архитектуры — 3 октября 2025

## Резюме

- Базовый стек подтверждён: **Next.js 15.5.3 (App Router, React 19)**, **Strapi v5.23.6**, **PostgreSQL 14-alpine**, **Redis 7-alpine**, **Meilisearch v1.7**, **Nginx + Certbot**.
- В Strapi включён REST-кеш на базе `@strapi-community/plugin-rest-cache` с провайдером Redis; конфигурация управляется переменными окружения (`REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`, `REDIS_TLS`, `REDIS_CACHE_DB`, `REDIS_CACHE_PREFIX`, `REDIS_CACHE_TTL`, `REDIS_CACHE_CONTENT_TYPES`).
- Подключено S3-совместимое хранилище (Beget S3 в проде, MinIO в dev) через провайдер `aws-s3`; `S3_CDN_BASE_URL`/`NEXT_PUBLIC_ASSET_HOST` задают публичный CDN-хост.
- Compose-профили дополнены сервисами `redis` и `minio`, окружения расширены S3/CDN параметрами для Strapi и фронта.
- Документация (README + «Результаты и демонстрация по этапам») расширена описанием кеша, S3/CDN и процедур ручной очистки кеша и smoke-чеков загрузок.

## Компоненты

### Frontend (Next.js)
- Состав зависимостей и pipeline без изменений; фронт общается со Strapi через `API_CONTAINER_URL`/`API_CLIENT_URL`, как и раньше.
- `next.config.ts` парсит `NEXT_PUBLIC_ASSET_HOST`, разрешает изображение с MinIO (порт 9000) и CDN Beget (`remotePatterns` с протоколом/хостом/портом) и пробрасывает значение в рантайм.
- `NEXT_PUBLIC_ASSET_HOST` приходит из docker/Strapi окружений, поэтому фронт и CMS используют единый источник правды для CDN.

### CMS (Strapi)
- Добавлены зависимости `@strapi-community/plugin-redis`, `@strapi-community/plugin-rest-cache`, `@strapi-community/provider-rest-cache-redis`, сохранён `better-sqlite3` для локального профиля SQLite.
- Провайдер загрузки переведён на `aws-s3`: в `providerOptions.s3Options` прокидываются креденшалы и endpoint Beget/MinIO, `forcePathStyle` включает path-style для dev, `baseUrl` читает CDN-домен.
- В `config/plugins.ts` заведён коннектор `redis.default`, стратегия `plugin::rest-cache` с провайдером Redis, кастомным префиксом и TTL; стартовый whitelist контента — публичные коллекции витрины (страницы, категории, товары, коллекции).
- Создан хелпер `src/utils/cache.ts` для доступа к дефолтному соединению Redis и будущей ручной очистки/инвалидции.

### Облачное хранилище / CDN
- Dev Compose содержит сервис `minio` (`minio/minio`, `server /data --console-address :9001`), volume `minio-data` и проброс портов 9000/9001 наружу; Strapi/Frontend зависят от MinIO и получают креденшалы через ENV.
- Prod Compose использует endpoint Beget S3 (`S3_ENDPOINT=https://s3.storage.beget.tech`, `S3_FORCE_PATH_STYLE=false`) и CDN-домен `S3_CDN_BASE_URL`; Strapi генерирует абсолютные ссылки на CDN, фронт отдаёт их через `next/image`.
- README зафиксировал регламент Beget CDN: ручное создание бакета, включение CDN-ресурса, настройку CORS, привязку CNAME, проверку TTL/Cache-Control и контроль HIT/MISS через dev-tools.

### Кеширование / Redis
- Новый сервис `redis` описан в обоих compose-файлах: образ `redis:7-alpine`, проброс volume для данных, сеть `internal`. Strapi получает подключения через переменные окружения.
- README фиксирует включение кеша, новые ENV и пример очистки: `pnpm --filter strapi strapi console` → `strapi.plugin('rest-cache').service('cacheManager').clear()`.
- Smoke-тест: `pnpm --filter strapi develop`, повторный GET к кешируемому endpoint возвращает `x-rest-cache: HIT`, ключи появляются в Redis (`redis-cli -n $REDIS_CACHE_DB keys "$REDIS_CACHE_PREFIX*"`).

### Compose-профили и окружение
- `docker/.env.example` расширен блоками Redis (`HOST`, `PORT`, `PASSWORD`, `TLS`, `CACHE_DB`, `CACHE_PREFIX`, `CACHE_TTL`, `CACHE_CONTENT_TYPES`) и S3/CDN (`S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`, `S3_BUCKET`, `S3_REGION`, `S3_ENDPOINT`, `S3_FORCE_PATH_STYLE`, `S3_CDN_BASE_URL`, `NEXT_PUBLIC_ASSET_HOST`).
- `strapi/.env.example` повторяет ключевые параметры, чтобы CLI поднимал те же подключения без Docker.
- Для избавления от предупреждений Compose достаточно запускать через `./compose.sh <profile>` либо указать `--env-file .env.development/.env.production`, чтобы переменные подтянулись из нужного шаблона.

### Документация
- README описывает режим работы REST-кеша, интеграцию S3/CDN, чек-лист создания бакета/подключения CDN и набор новых переменных окружения.
- «Результаты и демонстрация по этапам» дополнен сведениями об интеграции Redis и переходе на S3/Beget/CDN на этапе Backend.
- Добавлен чек-лист smoke-теста: `pnpm --filter strapi develop`, загрузка файла, проверка объекта в MinIO/Beget и заголовков CDN (HIT/MISS) на фронте.

## Операционные наблюдения

- При запуске Strapi вне Docker (CLI/локально) остаётся профиль SQLite, поэтому зависимость `better-sqlite3` обязательна, иначе `pnpm develop` падает до переопределения `DATABASE_CLIENT` на postgres.
- MinIO не создаёт бакеты автоматически: перед первым запуском dev-стека нужно руками завести `S3_BUCKET` (через консоль на 9001 или `mc mb --ignore-existing`). В бою бакет создаётся заранее в панели Beget.
- Для MinIO нужен `S3_FORCE_PATH_STYLE=true`, иначе `aws-s3` будет пытаться использовать virtual-hosted-style и получать ошибки DNS/SSL.
- Docker Compose читает только `.env` рядом с файлом, поэтому без `--env-file` предупреждения об отсутствующих переменных неизбежны.

## Следующие шаги

1. Добавить CLI-хук/скрипт для точечной очистки кеша конкретных коллекций (используя `src/utils/cache.ts`).
2. Автоматизировать smoke-тесты: скрипт создания бакета `mc mb --ignore-existing`, загрузка файла и проверка CDN-заголовков.
3. Прописать метрики/алерты на промахи Redis, время ответа Strapi и ошибки загрузки в S3/CDN.
4. (Опционально) Задекларировать IaC-плейбуки для Beget: создание бакета, выпуск CDN-домена, управление CORS/TTL.
